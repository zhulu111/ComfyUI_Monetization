import{app}from"../../../scripts/app.js";import{api}from"../../../scripts/api.js";import{ComfyWidgets}from"../../../scripts/widgets.js";import{$el}from"../../../scripts/ui.js";const styleElement=document.createElement("style"),cssCode="\n    #msgDiv{\n      width:800px;\n      height: 200px;\n      text-align: center;\n      font-size: 30px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      padding-bottom: 40px;\n      color: var(--fg-color);\n    }\n    #qrCode{\n      display: block;\n      width:256px;\n      height:256px;\n      border-radius: 10px;\n    }\n    #qrBox{\n      display: block;\n      text-align: center;\n      display:flex;\n      flex-wrap: wrap;\n      justify-content: center;\n      width: 360px;\n    }\n    #qrDesc{\n      display: block;\n      text-align: center;\n      margin-top: 20px;\n      color: #ffffff;\n      width: 360px;\n    }\n    .codeImg {\n      // display: block;\n      width:256px;\n      height:256px;\n      border-radius: 10px;\n      padding: 10px;\n      border: 2px solid #ffffff;\n    }\n    .codeDesc {\n      display: block;\n      text-align: center;\n      margin-top: 20px;\n      color: #ffffff;\n      width: 360px;\n      font-size: 16px;\n    }\n    .codeDiv {\n      color: #ffffff;\n    }\n    .codeBox {\n      display: flex;\n      text-align: center;\n    }\n    #directions{\n      margin-top: 10px;\n      width: 100%;\n      text-align: left;\n      color: #ffffff;\n      font-size: 8px;\n    }\n    .tech_button {\n      flex:1;\n      height:30px;\n      border-radius: 8px;\n      border: 2px solid var(--border-color);\n      font-size:11px;\n      background:var(--comfy-input-bg);\n      color:var(--error-text);\n      box-shadow:none;\n      cursor:pointer;\n      width: 1rem;\n    }\n    #tech_box {\n      max-height: 80px;\n      display:flex;\n      flex-wrap: wrap;\n      align-items: flex-start;\n    }\n    .uniqueid {\n      display: none;\n    }\n    #showMsgDiv {\n      width:800px;\n      padding: 60px 0;\n      text-align: center;\n      font-size: 30px;\n      color: var(--fg-color);\n    }\n";styleElement.innerHTML=cssCode,document.head.appendChild(styleElement);var techsidkey="techsid"+window.location.port,loading=!1;const msgBox=$el("div.comfy-modal",{parent:document.body},[]),msgDiv=$el("div",{id:"msgDiv"},"");function setCookie(e,t,o=1){var s={value:t,expires:new Date((new Date).getTime()+24*o*60*60*1e3)};localStorage.setItem(e,JSON.stringify(s))}function getCookie(e){var t=localStorage.getItem(e);return t?(t=JSON.parse(t),new Date(t.expires)>new Date?t.value:(localStorage.removeItem(e),"")):""}function generateTimestampedRandomString(){return(Date.now().toString(36)+Array(3).fill(0).map((()=>Math.random().toString(36).substring(2))).join("").substring(0,18)).substring(0,32)}function showLoading(e=""){hideLoading(),msgDiv.innerText=e||"请稍后...",msgBox.style.display="block",loading=!0}function hideLoading(){msgBox.style.display="none",loading=!1}function showToast(e="",t=0){t=t>0?t:2e3,msgDiv.innerText=e||"谢谢",msgBox.style.display="block",setTimeout((()=>{msgBox.style.display="none"}),t)}msgBox.appendChild(msgDiv),msgBox.style.display="none",msgBox.style.zIndex=10001;var serverUrl=window.location.href;const qrCode=$el("img",{id:"qrCode",src:"",onerror:()=>{}}),qrDesc=$el("div",{id:"qrDesc"},"请用微信扫码，验证身份..."),qrBox=$el("div",{id:"qrBox"},[qrCode,qrDesc]);app.ui.dialog.element.style.zIndex=10010;const showMsgDiv=$el("div",{id:"showMsgDiv"},"请稍后...");function showCodeBox(e){app.ui.dialog.close();let t=[];for(let o=0;o<e.length;o++)t.push($el("div.codeDiv",{},[$el("img.codeImg",{src:e[o].code}),$el("div.codeDesc",{},e[o].desc)]));const o=$el("div.codeBox",{},t);app.ui.dialog.show(o)}function showQrBox(e,t){app.ui.dialog.close(),qrDesc.innerText=t,qrCode.src=e,app.ui.dialog.show(qrBox)}function hideCodeBox(){app.ui.dialog.close()}function showMsg(e){app.ui.dialog.close(),showMsgDiv.innerText=e,app.ui.dialog.show(showMsgDiv)}function hideMsg(){app.ui.dialog.close()}function tech_alert(e){loading=!1,showMsg(e)}function getPostData(e){const t=e.output;console.log(t);let o=0,s={},i={},n={},d=[];for(const e in t)"ComfyMon"==t[e].class_type&&(s=t[e].inputs,o++),"SaveImage"!=t[e].class_type&&"VHS_VideoCombine"!=t[e].class_type||(t[e].res_node=e,d.push(t[e]));if(o>1)return"工作流中只可以存在1个“SD变现宝”节点";if(d.length<1)return"请确保工作流中有且仅有1个“SaveImgae”或“VHS_VideoCombine”节点，目前有"+d.length+"个";if(d.length>1)return"请确保工作流中有且仅有1个“SaveImgae”或“VHS_VideoCombine”节点，目前有"+d.length+"个";if(n.res_node=d[0].res_node,s){if(i.zhutu1=s["app_img1(optional)"],i.zhutu2=s["app_img2(optional)"],i.zhutu3=s["app_img3(optional)"],i.cs_img1=s["custom_img1(optional)"],i.cs_img2=s["custom_img2(optional)"],i.cs_img3=s["custom_img3(optional)"],i.cs_video1=s["custom_video1(optional)"],i.cs_video2=s["custom_video2(optional)"],i.cs_video3=s["custom_video3(optional)"],i.cs_text1=s["custom_text1(optional)"],i.cs_text2=s["custom_text2(optional)"],i.cs_text3=s["custom_text3(optional)"],i.title=s.app_title,i.gn_desc=s.app_desc,i.sy_desc="作品使用说明",i.server=serverUrl,i.fee=s.app_fee,i.free_times=s.free_times,i.cs_img1_desc=s.custom_img1_desc,i.cs_img2_desc=s.custom_img2_desc,i.cs_img3_desc=s.custom_img3_desc,i.cs_video1_desc=s.custom_video1_desc,i.cs_video2_desc=s.custom_video2_desc,i.cs_video3_desc=s.custom_video3_desc,i.cs_text1_desc=s.custom_text1_desc,i.cs_text2_desc=s.custom_text2_desc,i.cs_text3_desc=s.custom_text3_desc,i.uniqueid=s.uniqueid,n.zhutus=[],i.zhutu1){if("LoadImage"!=t[i.zhutu1[0]].class_type)return"“app_img1”只可以连接“LoadImage”节点";t[i.zhutu1[0]].inputs.image&&n.zhutus.push(t[i.zhutu1[0]].inputs.image)}if(i.zhutu2){if("LoadImage"!=t[i.zhutu2[0]].class_type)return"“app_img2”只可以连接“LoadImage”节点";t[i.zhutu2[0]].inputs.image&&n.zhutus.push(t[i.zhutu2[0]].inputs.image)}if(i.zhutu3){if("LoadImage"!=t[i.zhutu3[0]].class_type)return"“app_img3”只可以连接“LoadImage”节点";t[i.zhutu3[0]].inputs.image&&n.zhutus.push(t[i.zhutu3[0]].inputs.image)}if(n.cs_img_nodes=[],console.log(t),console.log(i.cs_img1),i.cs_img1){if(console.log(t[i.cs_img1[0]]),"LoadImage"!=t[i.cs_img1[0]].class_type)return"“custom_img1”只可以连接“LoadImage”节点";n.cs_img_nodes.push({node:i.cs_img1[0],desc:i.cs_img1_desc})}if(i.cs_img2){if("LoadImage"!=t[i.cs_img2[0]].class_type)return"“custom_img2”只可以连接“LoadImage”节点";n.cs_img_nodes.push({node:i.cs_img2[0],desc:i.cs_img2_desc})}if(i.cs_img3){if("LoadImage"!=t[i.cs_img3[0]].class_type)return"“custom_img3”只可以连接“LoadImage”节点";n.cs_img_nodes.push({node:i.cs_img3[0],desc:i.cs_img3_desc})}if(n.cs_video_nodes=[],i.cs_video1){if("VHS_LoadVideo"!=t[i.cs_video1[0]].class_type)return"“custom_video1”只可以连接“Load Video (Upload) 🎥🅥🅗🅢”节点";n.cs_video_nodes.push({node:i.cs_video1[0],desc:i.cs_video1_desc})}if(i.cs_video2){if("VHS_LoadVideo"!=t[i.cs_video2[0]].class_type)return"“custom_video2”只可以连接“Load Video (Upload) 🎥🅥🅗🅢”节点";n.cs_video_nodes.push({node:i.cs_video2[0],desc:i.cs_video2_desc})}if(i.cs_video3){if("VHS_LoadVideo"!=t[i.cs_video3[0]].class_type)return"“custom_video3”只可以连接“Load Video (Upload) 🎥🅥🅗🅢”节点";n.cs_video_nodes.push({node:i.cs_video3[0],desc:i.cs_video3_desc})}if(n.cs_text_nodes=[],i.cs_text1){if(!t[i.cs_text1[0]]||void 0===t[i.cs_text1[0]].inputs||void 0===t[i.cs_text1[0]].inputs.text)return"“custom_text1”只可以连接“textInput”节点";n.cs_text_nodes.push({node:i.cs_text1[0],desc:i.cs_text1_desc})}if(i.cs_text2){if(!t[i.cs_text2[0]]||void 0===t[i.cs_text2[0]].inputs||void 0===t[i.cs_text2[0]].inputs.text)return"“custom_text2”只可以连接“textInput”节点";n.cs_text_nodes.push({node:i.cs_text2[0],desc:i.cs_text2_desc})}if(i.cs_text3){if(!t[i.cs_text3[0]]||void 0===t[i.cs_text3[0]].inputs||void 0===t[i.cs_text3[0]].inputs.text)return"“custom_text3”只可以连接“textInput”节点";n.cs_text_nodes.push({node:i.cs_text3[0],desc:i.cs_text3_desc})}return i.title?(n.title=i.title,i.gn_desc?(n.gn_desc=i.gn_desc,i.sy_desc?(n.sy_desc=i.sy_desc,i.fee>=0?(n.fee=i.fee,i.free_times>=0?(n.free_times=i.free_times,n.uniqueid=i.uniqueid,n.output=t,console.log(n),n):"“free_times”不能小于0"):"“app_fee”不能小于0分，即0元"):"请填写作品使用说明"):"“app_desc”, 不可为空，请填写作品功能介绍"):"“app_title”, 不可为空，请填写作品标题"}}async function requestExe(e,t){var o=getCookie(techsidkey);const s=await api.fetchApi("/manager/tech_zhulu",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({r:e,techsid:o,postData:t})});if(console.log(s),!s.ok)return void setTimeout((()=>{showToast("网络连接出错，请保持电脑联网",3e3)}),300);return await s.json()}async function login(e){let t=await requestExe("comfyui.apiv2.code",{s_key:e});return"none"!=app.ui.dialog.element.style.display?(console.log(t.data.data.data),console.log("==========================="),t.data.data.data.techsid.length>5?"123456":(await new Promise((e=>setTimeout(e,800))),await login(e))):void 0}async function request(e,t){showLoading("处理中，请稍后...");let o=await requestExe(e,t);if(41009!=o.errno)return hideLoading(),o;{let o=await requestExe("comfyui.apiv2.code",{s_key:""});if(o){if(1==o.data.data.code){hideLoading(),showQrBox(o.data.data.data,o.data.data.desc);let s=await login(o.data.data.s_key);return hideCodeBox(),s?await request(e,t):void 0}return void showToast(o.data.data.message)}}}app.registerExtension({name:"ComfyMon",async beforeRegisterNodeDef(e,t,o){if("ComfyMon"===t.name){const t=e.prototype.onNodeCreated;e.prototype.onNodeCreated=function(){const e=t?t?.apply(this,arguments):void 0,s=(this.widgets.findIndex((e=>"zhanwei"===e.name)),$el("button.tech_button",{textContent:"点此，工作流转小程序/H5，并获取访问地址",style:{},onclick:async()=>{if(!loading){hideCodeBox();try{let e=getPostData(await o.graphToPrompt());if(!e.output)return void tech_alert(e);try{let t=await request("comfyui.apiv2.upload",e);console.log("resdataresdataresdataresdataresdataresdataresdataresdata"),console.log(t),console.log(t),console.log(t),console.log(t),console.log(t),console.log("resdataresdataresdataresdataresdataresdataresdataresdata"),t&&(1==t.data.data.code?showCodeBox(t.data.data.list):showMsg(t.data.data.message))}catch(e){hideLoading()}}catch(e){return console.log(e),void tech_alert("获取api数据失败")}}}})),i=$el("div",{id:"directions"},["特殊说明：",$el("br"),"1、每创建一个新的“SD变现宝”节点，就对应一个新的作品；",$el("br"),"2、如有问题，请加官方QQ群：967073981，联系作者咨询。",$el("br"),"3、视频教程：https://www.bilibili.com/video/BV1Bsg8eeEjv"]),n=$el("div",{id:"tech_box"},[s,i]);this.addDOMWidget("select_styles","btn",n);const d=document.createElement("input");return d.setAttribute("type","text"),d.setAttribute("list","uedynamiclist"),d.setAttribute("value",generateTimestampedRandomString()),d.className="uniqueid",this.addDOMWidget("uniqueid","input",d,{getValue:()=>d.value,setValue(e){d.value=e}}),setTimeout((()=>{this.setSize([420,500])}),200),e},e.prototype.onRemoved=function(){},this.serialize_widgets=!0}}});